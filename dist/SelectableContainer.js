"use strict";require("core-js/modules/es.symbol.description.js"),require("core-js/modules/es.weak-map.js"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,require("core-js/modules/web.dom-collections.iterator.js"),require("core-js/modules/es.array.includes.js"),require("core-js/modules/es.string.includes.js");var _react=_interopRequireWildcard(require("react")),_context=require("./context"),_SelectBox=_interopRequireDefault(require("./SelectBox")),_reactMergeRefs=require("react-merge-refs"),_utils=require("./utils");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function _getRequireWildcardCache(a){return a?c:b})(a)}function _interopRequireWildcard(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!=typeof a&&"function"!=typeof a)return{default:a};var c=_getRequireWildcardCache(b);if(c&&c.has(a))return c.get(a);var d={},e=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if("default"!=f&&Object.prototype.hasOwnProperty.call(a,f)){var g=e?Object.getOwnPropertyDescriptor(a,f):null;g&&(g.get||g.set)?Object.defineProperty(d,f,g):d[f]=a[f]}return d.default=a,c&&c.set(a,d),d}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b=_toPropertyKey(b),b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function _toPropertyKey(a){var b=_toPrimitive(a,"string");return"symbol"==typeof b?b:b+""}function _toPrimitive(a,b){if("object"!=typeof a||null===a)return a;var c=a[Symbol.toPrimitive];if(c!==void 0){var d=c.call(a,b||"default");if("object"!=typeof d)return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===b?String:Number)(a)}const SelectableContainer=a=>{const{children:b,onSelectionFinish:c,scrollSpeed:d=.25,minimumSpeedFactor:e=60,delta:f=1,tolerance:g=0,globalMouse:h=!1,allowAltClick:i=!1,allowCtrlClick:j=!1,allowMetaClick:k=!1,allowShiftClick:l=!1,selectOnClick:m=!0,resetOnStart:n=!1,deselectOnEsc:o=!0,allowClickWithoutSelected:p=!0}=a,q=(0,_react.useRef)(null),r=(0,_react.useRef)(null),s=(0,_react.useRef)(null),t=(0,_react.useRef)(null),u=(0,_react.useRef)(new Set),v=(0,_react.useRef)(new Set),w=(0,_react.useRef)({selectboxY:0,selectboxX:0,target:null}),x=(0,_react.useRef)({scrollTop:0,scrollLeft:0}),y=(0,_react.useRef)({scrollTop:0,scrollLeft:0}),z=(0,_react.useRef)({x:0,y:0,width:0,height:0}),A=(0,_react.useRef)({top:0,left:0,width:0,height:0,offsetWidth:0,offsetHeight:0}),B=(0,_react.useRef)(0),C=(0,_react.useRef)(0),D=(0,_react.useRef)(null),E=(0,_react.useRef)([]),F=(0,_react.useRef)(!1),G=(0,_react.useRef)(!1),H=(0,_react.useRef)(!1),I=(0,_react.useRef)(!1),J=(0,_react.useRef)(!1),K=(0,_react.useRef)(!1),L=()=>{const{scrollTop:a,scrollLeft:b}=r.current;x.current={scrollTop:a,scrollLeft:b}},M=()=>{const{documentScrollLeft:a,documentScrollTop:b}=(0,_utils.getDocumentScroll)();y.current={scrollTop:b,scrollLeft:a}},N=()=>{document.removeEventListener("mousemove",Y),document.removeEventListener("touchmove",Y),document.removeEventListener("mouseup",Z),document.removeEventListener("touchend",Z)};(0,_react.useEffect)(()=>(r.current=a.scrollContainer?document.querySelector(a.scrollContainer):q.current,r.current.addEventListener("scroll",L),document.addEventListener("scroll",M),q.current.addEventListener("mousedown",X),q.current.addEventListener("touchstart",X),o&&(document.addEventListener("keydown",$),document.addEventListener("keyup",$)),()=>{r.current.removeEventListener("scroll",L),document.removeEventListener("scroll",M),q.current.removeEventListener("mousedown",X),q.current.removeEventListener("touchstart",X),o&&(document.removeEventListener("keydown",$),document.removeEventListener("keyup",$)),N(),u.current.clear(),v.current.clear()}),[]);const O=()=>{const a={scrollTop:x.current.scrollTop+y.current.scrollTop,scrollLeft:x.current.scrollLeft+y.current.scrollLeft};for(const b of E.current)b.current.hBounds=(0,_utils.getBoundsForNode)(b.current,a)},P=()=>{D.current=r.current.getBoundingClientRect(),B.current=r.current.scrollHeight-r.current.clientHeight,C.current=r.current.scrollWidth-r.current.clientWidth},Q=a=>{const{scrollTop:b,scrollLeft:c}=x.current;S(a.clientY,b),T(a.clientY,b),U(a.clientX,c),V(a.clientX,c)},R=a=>{var b;return null!==(b=Math.max(a,null!==e&&void 0!==e?e:0)*d)&&void 0!==b?b:1},S=(a,b)=>{var c,d;const e=null!==(c=null===(d=D.current)||void 0===d?void 0:d.top)&&void 0!==c?c:0-a;(0<e||0>a)&&(r.current.scrollTop=b-R(e))},T=(a,b)=>{var c,d;const e=null!==(c=a-(null===(d=D.current)||void 0===d?void 0:d.bottom))&&void 0!==c?c:0;if(0<e||a>window.innerHeight){const a=b+R(e);r.current.scrollTop=Math.min(a,B.current)}},U=(a,b)=>{var c,d;const e=null!==(c=null===(d=D.current)||void 0===d?void 0:d.left)&&void 0!==c?c:0-a;if(0<e||0>a){const a=b-R(e);r.current.scrollLeft=a}},V=(a,b)=>{var c,d;const e=null!==(c=a-(null===(d=D.current)||void 0===d?void 0:d.right))&&void 0!==c?c:0;if(0<e||a>window.innerWidth){const a=b+R(e);r.current.scrollLeft=Math.min(a,C.current)}},W=()=>{for(const a of u.current.values())a.isSelected=!1,u.current.delete(a)},X=a=>{var b,c,d,e;const f=!a.type.includes("touch")&&!(0,_utils.detectMouseButton)(a,1,{allowAltClick:i,allowCtrlClick:j,allowMetaClick:k,allowShiftClick:l});if(!(F.current||f)){n&&W(),F.current=!0,I.current=!1;const f=(0,_utils.castTouchToMouseEvent)(a);if(!h&&!(0,_utils.isNodeInRoot)(f.target,q.current)){const[a]=(0,_utils.getBoundsForNode)(q.current,y.current),b=(0,_utils.doObjectsCollide)({top:a.top,left:a.left,width:0,height:0,offsetHeight:a.offsetHeight,offsetWidth:a.offsetWidth},{top:f.pageY,left:f.pageX,width:0,height:0,offsetWidth:0,offsetHeight:0});if(!b)return}P(),O(),w.current={target:f.target,selectboxY:null!==(b=f.clientY-(null===(c=D.current)||void 0===c?void 0:c.top))&&void 0!==b?b:0+x.current.scrollTop,selectboxX:null!==(d=f.clientX-(null===(e=D.current)||void 0===e?void 0:e.left))&&void 0!==d?d:0+x.current.scrollLeft},f.preventDefault(),document.addEventListener("mousemove",Y),document.addEventListener("touchmove",Y),document.addEventListener("mouseup",Z),document.addEventListener("touchend",Z)}},Y=a=>{var b,c,d,e,f,g,h,i;const j=(0,_utils.castTouchToMouseEvent)(a);if(Q(j),G.current)return;G.current=!0,H.current=!0;const{clientX:k,clientY:l}=j,m=null!==(b=l-(null===(c=D.current)||void 0===c?void 0:c.top))&&void 0!==b?b:0+x.current.scrollTop,n=Math.min(m,w.current.selectboxY),o=null!==(d=k-(null===(e=D.current)||void 0===e?void 0:e.left))&&void 0!==d?d:0+x.current.scrollLeft,p=Math.min(o,w.current.selectboxX);z.current={x:p,y:n,width:Math.abs(o-w.current.selectboxX),height:Math.abs(m-w.current.selectboxY)},A.current={top:null!==(f=z.current.y+(null===(g=D.current)||void 0===g?void 0:g.top))&&void 0!==f?f:0+y.current.scrollTop,left:null!==(h=z.current.x+(null===(i=D.current)||void 0===i?void 0:i.left))&&void 0!==h?h:0+y.current.scrollLeft,width:z.current.width,height:z.current.height,offsetWidth:z.current.width||1,offsetHeight:z.current.height||1},s.current.style.left=z.current.x+"px",s.current.style.top=z.current.y+"px",s.current.style.width=z.current.width+"px",s.current.style.height=z.current.height+"px",G.current=!1},Z=a=>{if(I.current)return;if(I.current=!0,F.current=!1,N(),!w.current)return;const b=(0,_utils.castTouchToMouseEvent)(a),{pageX:d,pageY:e}=b;if(!H.current&&(0,_utils.isNodeInRoot)(b.target,q.current))_(b,e,d);else{1===b.which&&w.current.target===b.target&&aa(b.target,"click"),z.current={x:0,y:0,width:0,height:0},s.current.style.left=z.current.x+"px",s.current.style.top=z.current.y+"px",s.current.style.width=z.current.width+"px",s.current.style.height=z.current.height+"px",ba(A.current);for(const a of v.current.values())a.isSelected=!0,a.isSelecting=!1;u.current=new Set([...u.current,...v.current]),v.current.clear(),A.current={top:0,left:0,width:0,height:0,offsetWidth:0,offsetHeight:0},c(u.current)}K.current=!1,J.current=!1,H.current=!1},$=a=>{27===a.keyCode&&W()},_=(b,c,d)=>{if(!m)return;const{clickClassNameS:e,allowClickWithoutSelected:f,onSelectionFinish:g}=a,h=b.target.classList||[],i=Array.from(h),j=e.some(a=>i.includes(a));(f||u.current.size||j||b.ctrlKey)&&(ba({top:c,left:d,width:0,height:0,offsetWidth:0,offsetHeight:0},{isFromClick:!0}),g([...u.current],t.current),1===b.which&&aa(b.target,"click"),(2===b.which||3===b.which)&&aa(b.target,"contextmenu"))},aa=(a,b)=>{const c=d=>{a.removeEventListener(b,c,!0),d.preventDefault(),d.stopPropagation()};a.addEventListener(b,c,!0)},ba=(b,c)=>{const{enableDeselect:d,mixedDeselect:e}=a;E.current.forEach(a=>{ca({item:a.current,selectboxBounds:b,tolerance:g,mixedDeselect:!(null===e||void 0===e)&&e,enableDeselect:!(null===d||void 0===d)&&d,isFromClick:c&&c.isFromClick})})},ca=a=>{const{item:b,tolerance:c,selectboxBounds:d,enableDeselect:e,mixedDeselect:g,isFromClick:h}=a,i=(0,_utils.doObjectsCollide)(d,b.hBounds,c,f),{isSelecting:j,isSelected:k}=b;if(h&&i)return k?u.current.delete(b):u.current.add(b),b.isSelected=!k,t.current=b,b;if(!h&&i){if(k&&e&&(!J.current||g))return b.isSelected=!1,b.deselected=!0,K.current=!0,u.current.delete(b);const a=g?!b.deselected:!K.current;if(!j&&!k&&a)return b.isSelecting=!0,J.current=!0,v.current.add(b),{updateSelecting:!0}}return!h&&!i&&j&&v.current.has(b)?(b.setState({isSelecting:!1}),v.current.delete(b),{updateSelecting:!0}):null};return/*#__PURE__*/_react.default.createElement("div",{ref:q,className:"selectable-container",style:_objectSpread(_objectSpread({},{position:"relative"}),a.style)},/*#__PURE__*/_react.default.createElement(_context.context.Provider,{value:{subscribe:a=>{E.current=[...E.current,a]},unSubscribe:a=>{E.current=E.current.filter(b=>b.current!==a.current)}}},b),/*#__PURE__*/_react.default.createElement(_SelectBox.default,{ref:s}))};var _default=SelectableContainer;exports.default=_default;